<!DOCTYPE html>
<html>
	<head>
		<title>Blogi testimine</title>
		<meta charset="UTF-8">
		<link rel="stylesheet" type="text/css" href="css/blog.css">
		<link type="text/css" rel="stylesheet" href="css/simplePagination.css"/>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
		<script type="text/javascript" src="js/jquery.simplePagination.js"></script>
		<script>
			var maxPosts;
			var pageNr = 1;
		
			$(document).ready(function(){
				getPosts(pageNr);
				getMaxPosts();
				
				$(".pageBtn").bind("click", "div", function(e) {
					var target = $(e.target);
					console.log(target.attr("id").slice(4));
					
				});
			});
			
			function paginationSetup() {
				$("#pager").pagination({
					items: 6,
					itemsOnPage: 5,
					cssStyle: 'compact-theme',
					edges: 1,
					onInit: function() {
						$("#pager").pagination("updateItems", maxPosts);
					},
					onPageClick: function(pageNumber) {
						pageNr = pageNumber;
						$("#main").empty();
						getPosts(pageNr);
					}
				});
			};
			
			// Võtab andmebaasist olemasolevad postitused.
			function getPosts(_pageNr) {	
				$.ajax({
					type: "POST",
					url: "php/getposts.php",
					data:{"pagenr": _pageNr},
					success: function(data) {
						handleData(data);
					}
				});
			}
			
			function getMaxPosts() {
				$.ajax({
					url: "php/getPostTotal.php",
					success: function(data) {
						maxPosts = data;
						paginationSetup();
					}
				});
			}
			
			// Tegeleb saadud andmetega edasi 
			function handleData(data) {
				var results = jQuery.parseJSON(data);
				for (var i = results.length - 1; i >= 0; i--){
					$("#main").append("<div class='post' id='"+results[i].post_ID+"'></div>");
					$("#"+results[i].post_ID).append("<img src='"+results[i].img+"' height='300'>");
					$("#"+results[i].post_ID).append("<h1>"+results[i].pealkiri+"</h1>");
					// Lisab click eventi, mille abil edastatakse id, et kuvada kogu postitust.
					$("#"+results[i].post_ID).bind("click", "div", function(e) {
						var target = $(e.target);
						if (target.is("img") || target.is("h1")) {
							window.location = "view.php?id=" + target.parent().attr("id") ;
						} else {
							window.location = "view.php?id=" + target.attr("id");
						}
					});
				}
			}
		</script>
	</head>
	
	<body>
		<!-- Lehtede kuvamiseks. Igal lehel on teatud hulk postitusi -->
		<div id="pager">

		</div>
		<!-- Siia lisatakse olemasolevad postitused -->
		<div id="main"></div>
		
	</body>
</html>